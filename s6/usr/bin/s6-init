#!/bin/sh
set -u 
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin

. /etc/rc.conf

msg() {
        # bold
	printf "\033[1m=> %s\033[m\n" "$@"
}

msg "Welcome to Gentoo!"
msg "Where the code is compiled and upstream doesn't matter..."

msg "mounting pseudo filesystems ..."
s6-mount -o nosuid,noexec,nodev        -t proc proc /proc &
s6-mount -o nosuid,noexec,nodev        -t sysfs sys /sys &
s6-mount -o size=100%,mode=755,noatime -t tmpfs tmpfs /run &
s6-ln -s sda3 /dev/root &

wait 

s6-mkdir -p -m0755 /dev/pts /dev/shm &
s6-mkdir -p -m1777 /dev/mqueue &

wait 

s6-mount -o noexec,nosuid,nodev -n -t mqueue mqueue /dev/mqueue &
s6-mount -o mode=0620,gid=5,nosuid,noexec -n -t devpts devpts /dev/pts &
s6-mount -o mode=1777,nosuid,nodev -n -t tmpfs shm /dev/shm &

wait

msg "starting udev ..."
/sbin/udevd --daemon
udevadm trigger --action=add --type=subsystems
udevadm trigger --action=add --type=devices

msg "fscking ..."
fsck -A -T -a -t noopts=_netdev
msg "remouting root read-write ..."
s6-mount -o remount,rw /dev/root /
msg "mounting all other local filesystems ..."
mount -a -t "nosysfs,nonfs,nonfs4,nosmbfs,nocifs"

msg "start networking"
ip link set up dev lo & 

msg "Setting your keymap"
loadkeys -q -u "$KEYMAP" 

msg "setting hostname"
s6-echo "$HOSTNAME" > /proc/sys/kernel/hostname &

msg "enabling swap"
s6-swapon -a &

msg "enabling sysctl"
sysctl -q --system & 

msg "Initializing random seed..."
cp /var/lib/random-seed /dev/urandom >/dev/null 2>&1 || true
( umask 077; bytes=$(cat /proc/sys/kernel/random/poolsize) || bytes=512; dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=$bytes >/dev/null 2>&1 )

msg "enabling binfmt"
/lib64/rc/sh/binfmt.sh

msg "creating /run/lock"
s6-mkdir -p /run/lock

msg "Initialization complete, passing on to s6-svscan"
exec s6-svscan /service
