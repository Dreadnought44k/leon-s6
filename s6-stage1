#!/bin/execlineb -S0

/bin/cd /

s6-echo "[s6-stage1] Welcome to Dragoon!"
s6-echo "[s6-stage1] Init powered by s6!"

s6-echo "[s6-stage1] mounting pseudo filesystems."
s6-mount -o nosuid,noexec,nodev        -t proc proc /proc 
s6-mount -o nosuid,noexec,nodev        -t sysfs sys /sys 
s6-mount -o size=100%,mode=0755        -t tmpfs tmpfs /run
s6-mount -o mode=0755,nosuid           -t devtmpfs dev /dev 
s6-ln -s sda3 /dev/root 

s6-echo "[s6-stage1] creating important folders."
s6-mkdir -p -m0755 /dev/pts /dev/shm 
s6-mkdir -p -m1777 /dev/mqueue 
s6-mkdir -p -m0755 /var/run/s6

s6-mount -o noexec,nosuid,nodev -n -t mqueue mqueue /dev/mqueue 
s6-mount -o mode=0620,gid=5,nosuid,noexec -n -t devpts devpts /dev/pts 
s6-mount -o mode=1777,nosuid,nodev -n -t tmpfs shm /dev/shm

s6-echo "[s6-stage1] doing a fsck"
fsck -A -T -a -t noopts=_netdev 
s6-echo "[s6-stage1] remounting root read-write" 
s6-mount -o remount,rw /dev/root /
s6-echo "[s6-stage1] mounting all other local filesystems"
mount -a -t "nosysfs,nonfs,nonfs4,nosmbfs,nocifs" -O no_netdev

if { s6-hiercopy "/etc/s6-linux-init"/run-image "/var/run"/s6 }

s6-echo "[s6-stage1] Preparing to create primitive s6-tree"
emptyenv -p
s6-envdir -I -- "/etc"/env-stage1
redirfd -r 0 /dev/null
redirfd -wnb 1 "/var/run"s6/service/s6-svscan-log/fifo
background
{
  # block until the supervision tree is running
  redirfd -w 3 /var/run/s6/services/s6-fdholderd/supervise/control
  fdclose 3

  # add some environment
  s6-envdir -- /etc/s6/env-stage2

  # run the script
  /bin/s6-stage2 $@
}
unexport !

s6-svscan -st0 /var/run/s6/service
